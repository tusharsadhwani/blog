<!DOCTYPE html>
<html lang="en" class="astro-KKTFMSIY">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üë®‚Äçüíª</text></svg>">

<!-- Primary Meta Tags -->
<title>Learn Python ASTs, by building your own linter</title>
<meta name="title" content="Learn Python ASTs, by building your own linter">
<meta name="description" content="The only resource you need to read to learn about ASTs in Python, and the superpowers they give you.">

<!-- Open Graph / Facebook -->
<meta property="og:type" content="website">
<meta property="og:url" content="https://tushar.lol">
<meta property="og:title" content="Learn Python ASTs, by building your own linter">
<meta property="og:description" content="The only resource you need to read to learn about ASTs in Python, and the superpowers they give you.">
<meta property="og:image" content="https://tushar.lol/images/ast.jpg">

<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image">
<meta property="twitter:url" content="https://tushar.lol">
<meta property="twitter:title" content="Learn Python ASTs, by building your own linter">
<meta property="twitter:description" content="The only resource you need to read to learn about ASTs in Python, and the superpowers they give you.">
<meta property="twitter:image" content="https://tushar.lol/images/ast.jpg">

<link rel="stylesheet" href="/style/global.css">
<link rel="stylesheet" href="/style/merged-themes.css">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inconsolata:wght@400;600&family=Open+Sans:wght@400;600&display=swap">



  <link rel="stylesheet" href="/assets/asset.e9fb454e.css"></link>
<link rel="stylesheet" href="/assets/asset.f321c214.css"></link>
<link rel="stylesheet" href="/assets/asset.f96c2ed2.css"></link><style astro-style="true">astro-root, astro-fragment { display: contents; }</style><script type="module" src="/entry.917bf5e219.js" astro-script="/post/ast/script-0"></script>
<script type="module" data-astro-component-hydration astro-script="/post/ast/script-1">import setup from '../../entry.8eab8588.js';
import 'data:text/javascript;charset=utf-8,//[no before-hydration script]';
setup("Z1Tf25X", {name:"Newsletter",value: "preact"}, async () => {
  const [{ default: Component }, { default: hydrate }] = await Promise.all([import("../../entry.9e2f0c78.js"), import("../../entry.a91cb9b9.js")]);
  return (el, children) => hydrate(el)(Component, {"class":"astro-KKTFMSIY"}, children);

});
</script>
<script type="module" data-astro-component-hydration astro-script="/post/ast/script-2">import setup from '../../entry.8eab8588.js';
import 'data:text/javascript;charset=utf-8,//[no before-hydration script]';
setup("WpNq3", {name:"Switch",value: "preact"}, async () => {
  const [{ default: Component }, { default: hydrate }] = await Promise.all([import("../../entry.c6bc87db.js"), import("../../entry.a91cb9b9.js")]);
  return (el, children) => hydrate(el)(Component, {"class":"astro-ZEBAPXNU"}, children);

});
</script>
</head>
  

  <body id="top">
    <header class="astro-ZEBAPXNU">
  <a href="/" class="astro-ZEBAPXNU">
    <svg viewBox="0 0 400 400" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg" width="400" height="400" version="1.1" class="astro-ZEBAPXNU">
      <g class="astro-ZEBAPXNU">
        <rect width="380" height="380" x="10" y="10" stroke="var(--text-color)" stroke-width="18" rx="18" fill-opacity="0" class="astro-ZEBAPXNU"></rect>
        <text x="52.5" y="357.427" font-family="sans-serif" font-size="250" font-weight="bold" text-anchor="start" transform="matrix(0.946786642074585,0,0,1.0035842657089233,19.687279514968395,-1.4603642597794533)" xml:space="preserve" style="stroke: var(--text-color); fill: var(--text-color)" class="astro-ZEBAPXNU">TS</text>
      </g>
    </svg>

  </a>
  <div class="right astro-ZEBAPXNU">
    <a href="/rss.xml" title="RSS" class="astro-ZEBAPXNU"><img style="height: 36px; padding: 4px;" src="/rss.png" alt="RSS" class="astro-ZEBAPXNU"></a>
    <astro-root uid="WpNq3"></astro-root>
  </div>
</header>



    <div class="layout astro-44HSQUML">
  <header class="astro-44HSQUML">
    <p class="publish-date astro-44HSQUML">Wednesday, 29 December 2021</p>
    <h1 class="title astro-44HSQUML">Learn Python ASTs, by building your own linter</h1>
    <p class="description astro-44HSQUML">The only resource you need to read to learn about ASTs in Python, and the superpowers they give you.</p>
    <img src="/images/ast.jpg" title="Learn Python ASTs, by building your own linter" alt="Learn Python ASTs, by building your own linter" class="astro-44HSQUML">
    
<div class="author astro-BL6UQIAR">
  <p class="astro-BL6UQIAR"><a href="https://twitter.com/sadhlife" class="astro-BL6UQIAR">@tusharsadhwani</a></p>
</div>

  </header>
  <article class="content astro-44HSQUML">
    <main class="astro-44HSQUML">
      <blockquote>
<p>Hi! Before we start, a word of caution: This is an extremely long article, and it might take multiple hours to finish completely. But I promise it'll be worth it.</p>
<p>Oh, and follow me on <a href="https://twitter.com/tusharisanerd">twitter</a>, I frequently post Python content there as well.</p>
</blockquote><h3 id="index">Index</h3><ul>
<li><a href="#so-what-is-an-ast">So what is an AST?</a></li>
<li><a href="#pythons-ast-module">Python's <code>ast</code> module</a>
<ul>
<li><a href="#all-the-nodes">All the <code>Node</code>s</a></li>
<li><a href="#expressions-vs-statements">Expressions vs. Statements</a></li>
<li><a href="#whats-a-ctx">What's a <code>ctx</code>?</a></li>
</ul>
</li>
<li><a href="#walking-the-syntax-trees-with-visitors">Walking the Syntax Trees with Visitors</a></li>
<li><a href="#the-power-of-ast-manipulation">The power of AST manipulation</a></li>
<li><a href="#lets-build-a-simple-linter">Let's build: A simple linter</a></li>
<li><a href="#ast-utilities">AST utilities</a></li>
<li><a href="#what-about-code-formatters">What about code formatters?</a></li>
<li><a href="#where-can-i-learn-more">Where can I learn more?</a></li>
</ul><h2 id="so-what-is-an-ast">So what is an AST?</h2><p>It's short for Abstract Syntax Tree. In programmer terms, "ASTs are a programmatic way to understand the structure of your source code". But to understand what that really means, we must first understand a few things about the structure of a computer program.</p><p>The programs that you and I write in our language of choice is usually called the "source code", and I'll be referring to it as such in this article.</p><p>On the other end, computer chips can only understand "machine code", which is a set of binary numbers that have special meanings for that model of the chip. Some of these numbers are <em>instructions</em>, which tell the CPU a simple task to perform, like "add the numbers stored in these two places", or "jump 10 numbers down and continue running code from there". The instructions run one by one, and they dictate the flow of the program.</p><p>Similarly, you define your programs as a set of "statements", with each statement being one thing that you want your code to do. They're sort of a more human-friendly version of the CPU instructions, that we can write and reason with more easily.</p><p>Now, I know that theory can get boring really quick, so I'm going to go through a bunch of examples. Let's write the same piece of code in many languages, and notice the similarities:</p><ul>
<li>
<p>Python</p>
<pre class="language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">area_of_circle</span><span class="token punctuation">(</span>radius<span class="token punctuation">)</span><span class="token punctuation">:</span>
    pi <span class="token operator">=</span> <span class="token number">3.14</span>
    <span class="token keyword">return</span> pi <span class="token operator">*</span> radius <span class="token operator">*</span> radius

area_of_circle<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
<span class="token comment"># Output: 78.5</span></code></pre>
</li>
<li>
<p>Scheme Lisp</p>
<pre class="language-lisp"><code class="language-lisp"><span class="token punctuation">(</span><span class="token car">define</span> <span class="token punctuation">(</span><span class="token car">area_of_circle</span> radius<span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token car">define</span> pi <span class="token number">3.14</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token car">*</span> pi radius radius<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token car">area_of_circle</span> <span class="token number">5</span><span class="token punctuation">)</span>
<span class="token comment">; Output: 78.5</span></code></pre>
</li>
<li>
<p>Go</p>
<pre class="language-go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">func</span> <span class="token function">area_of_circle</span><span class="token punctuation">(</span>radius <span class="token builtin">float64</span><span class="token punctuation">)</span> <span class="token builtin">float64</span> <span class="token punctuation">{</span>
  pi <span class="token operator">:=</span> <span class="token number">3.14</span>
  <span class="token keyword">return</span> pi <span class="token operator">*</span> radius <span class="token operator">*</span> radius
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">println</span><span class="token punctuation">(</span><span class="token function">area_of_circle</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// Output: +7.850000e+001</span></code></pre>
</li>
</ul><p>We're doing essentially the same thing in all of these, and I'll break it down piece by piece:</p><ul>
<li>
<p>We're defining our source code as a block of statements. In our case, there are two statements at the top-level of our source code: one statement that defines our <code>area_of_circle</code> function, and another statement that runs this function with the value "5".</p>
</li>
<li>
<p>The definition of the <code>area_of_circle</code> function has two parts: the input parameters (the radius, in our case), and the body, which itself is a block of statements. There's two statements inside <code>area_of_circle</code> to be specific: the first one defines <code>pi</code>, and the second one uses it to calculate the area, and returns it.</p>
</li>
<li>
<p>For the languages that have a main function, the definition of the main function itself is a statement. Inside that statement we are writing <em>more statements</em>, like one that prints out the value of <code>area_of_circle</code> called with the radius of 5.</p>
</li>
</ul><p>You can start to see the somewhat repetitive nature of source code. There's blocks of statements, and sometimes within those statements there can be more statements, and so on. If you imagine each statement to be a "node", then you can think of each of these nodes being composed of one or more other "nodes". You can properly define this kind of structure as a "tree":</p><pre class="language-text"><code class="language-text">                 (program)
                /         \
  (area_of_circle r)      (main)
  /           |             |
define    calculate        run area_of_circle
  pi        area             with r = 5
           /   |
     multiply  (pi, r, r)</code></pre><p>The nodes here can be anything, from statements, to expressions, to any other construct that the language defines. Once the code is in this tree structure, computers can start to make sense of it, such as traversing its nodes one by one and generate the appropriate machine code.</p><p>Essentially, all your code represents a tree of data. And that tree is called the <strong>Abstract Syntax Tree</strong>. Each programming language has its own AST representation, but the idea is always the same.</p><p>To be able to create tools that do things like auto-format your code, or find subtle bugs automatically, you need ASTs to be able to meaningfully read through the code, find items or patterns inside the code, and act on them.</p><h2 id="pythons-ast-module">Python's <code>ast</code> module</h2><p>Python has a builtin <code>ast</code> module, which has a rich set of features to create, modify and run ASTs from Python code. Not all languages provide easy access to their syntax trees, so Python is already pretty good in that regard. Let's take a look at what all the <code>ast</code> module gives us, and try to do something interesting with it:</p><h3 id="all-the-nodes">All the <code>Node</code>s</h3><p>There are lots of kinds of "Nodes" in a Python AST each with their own functionalities, but you can broadly divide them into four categories: <strong>Literals</strong>, <strong>Variables</strong>, <strong>Statements</strong> and <strong>Expressions</strong>. We'll take a look at them one by one, but before we do that we need to understand how a "Node" is represented.</p><p>The role of a node is to concretely represent the features of a language.</p><p>It does so by:</p><ul>
<li>Storing the attributes specific to itself, (for example, an <code>If</code> node that represents an if-statement might need a <code>condition</code> attribute, which is an expression that evaluates to <code>true</code> or <code>false</code>. The if statement's body will only run when <code>condition</code> ends up being <code>true</code>.</li>
<li>Defining what children the node can have. (In our <code>If</code> node's case, it should have a <code>body</code>, that is a list of statements.)</li>
</ul><blockquote>
<p>In Python's case, the AST nodes also hold their exact location in the source code. You can find out from where in the Python file a node came from, by checking the <code>lineno</code> and <code>col_offset</code> parameters.</p>
</blockquote><p>Let's see the concrete example of this if statement, in Python's AST representation.</p><p>For this source code:</p><pre class="language-python"><code class="language-python"><span class="token keyword">if</span> answer <span class="token operator">==</span> <span class="token number">42</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Correct answer!'</span><span class="token punctuation">)</span></code></pre><p>The AST looks like this:</p><pre class="language-python"><code class="language-python">Module<span class="token punctuation">(</span>
  body<span class="token operator">=</span><span class="token punctuation">[</span>
    If<span class="token punctuation">(</span>
      test<span class="token operator">=</span>Compare<span class="token punctuation">(</span>
        left<span class="token operator">=</span>Name<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'answer'</span><span class="token punctuation">,</span> ctx<span class="token operator">=</span>Load<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        ops<span class="token operator">=</span><span class="token punctuation">[</span>Eq<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        comparators<span class="token operator">=</span><span class="token punctuation">[</span>Constant<span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
      body<span class="token operator">=</span><span class="token punctuation">[</span>
        Expr<span class="token punctuation">(</span>
          value<span class="token operator">=</span>Call<span class="token punctuation">(</span>
            func<span class="token operator">=</span>Name<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'print'</span><span class="token punctuation">,</span> ctx<span class="token operator">=</span>Load<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            args<span class="token operator">=</span><span class="token punctuation">[</span>Constant<span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token string">'Correct answer!'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            keywords<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
          <span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      orelse<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  type_ignores<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span></code></pre><p>Let's break this down:</p><p>Ignoring the details for now, the overall structure of the AST looks like this:</p><pre class="language-python"><code class="language-python">Module<span class="token punctuation">(</span>
  body<span class="token operator">=</span><span class="token punctuation">[</span>
    If<span class="token punctuation">(</span>
      test<span class="token operator">=</span>Compare<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      body<span class="token operator">=</span><span class="token punctuation">[</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span></code></pre><p>At the top level, is a <code>Module</code>. All Python files are compiled as "modules" when making the AST. Modules have a very specific meaning: anything that can be run by Python classifies as a module. So by definition, our Python file is a module.</p><p>It has a body, which is a list. Specifically, a list of <strong>statements</strong>. All Python files are just that: a list of statements. Every Python program that you've ever written, read or run -- just that.</p><p>In our case, we have just one statement in the module's body: an <code>If</code>-statement. The if-statement has two components: a <code>test</code>, and a <code>body</code>. The <code>test</code> part holds the <em>condition expression</em>, and the <code>body</code> holds the block of statements that's inside the if.</p><p>Let's look at the <code>test</code> "expression" first:</p><pre class="language-python"><code class="language-python">If<span class="token punctuation">(</span>
  test<span class="token operator">=</span>Compare<span class="token punctuation">(</span>
    left<span class="token operator">=</span>Name<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'answer'</span><span class="token punctuation">,</span> ctx<span class="token operator">=</span>Load<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    ops<span class="token operator">=</span><span class="token punctuation">[</span>Eq<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    comparators<span class="token operator">=</span><span class="token punctuation">[</span>Constant<span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
  <span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code></pre><p>In our case, we have a <code>Compare</code> expression -- which makes sense. Python defines comparisons <a href="https://docs.python.org/3/reference/expressions.html#comparisons">quite thoroughly</a> in its reference, and if you read it, you'll find that Python supports <em>comparison chaining</em>.</p><p>From the docs:</p><blockquote>
<p>Python's comparison expressions support this syntax:</p>
<p><code>a op1 b op2 c ...</code></p>
<p>Which is equivalent to:</p>
<p><code>a op1 b and b op2 c and ...</code></p>
</blockquote><p>In human terms, this means that Python can support stuff like this:</p><pre class="language-python"><code class="language-python">x <span class="token operator">=</span> get_number<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token number">0</span> <span class="token operator">&lt;</span> x <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Your number is a single digit!'</span><span class="token punctuation">)</span></code></pre><p>And <code>0 &#x3C; x &#x3C; 10</code> is the same as asking <code>0 &#x3C; x and x &#x3C; 10</code>.</p><p>Here's the important part: for Python to support this, the <em>AST needs to support this</em>. And Python's AST supports comparison chaining by storing the operators and the comparators (variables) inside <strong>lists</strong>. You can look at it in the REPL itself:</p><pre class="language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> ast
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">def</span> <span class="token function">get_ast</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span>ast<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>ast<span class="token punctuation">.</span>parse<span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">,</span> indent<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">>></span><span class="token operator">></span> get_ast<span class="token punctuation">(</span><span class="token string">'a &lt; b > c > d'</span><span class="token punctuation">)</span>
Module<span class="token punctuation">(</span>
  body<span class="token operator">=</span><span class="token punctuation">[</span>
    Expr<span class="token punctuation">(</span>
      value<span class="token operator">=</span>Compare<span class="token punctuation">(</span>
        left<span class="token operator">=</span>Name<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'a'</span><span class="token punctuation">,</span> ctx<span class="token operator">=</span>Load<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        ops<span class="token operator">=</span><span class="token punctuation">[</span>Lt<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Gt<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Gt<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        comparators<span class="token operator">=</span><span class="token punctuation">[</span>
          Name<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'b'</span><span class="token punctuation">,</span> ctx<span class="token operator">=</span>Load<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          Name<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'c'</span><span class="token punctuation">,</span> ctx<span class="token operator">=</span>Load<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          Name<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'d'</span><span class="token punctuation">,</span> ctx<span class="token operator">=</span>Load<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  type_ignores<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span></code></pre><blockquote>
<p>If you actually run this code, you might notice that the output here has different whitespace compared to what I have in my blog. It's just personal preference, if you find an output similar to mine more readable you can install <code>astpretty</code> from pip, and use:</p>
<pre class="language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">get_ast</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">:</span>
    astpretty<span class="token punctuation">.</span>pprint<span class="token punctuation">(</span>ast<span class="token punctuation">.</span>parse<span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">,</span> show_offsets<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> indent<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span></code></pre>
</blockquote><p>You can see that the operators <code>&#x3C;</code>, <code>></code> and <code>></code> are stored as <code>ops=[Lt(), Gt(), Gt()]</code> inside the <code>Compare</code> object. The four values are stored a bit more peculiarly: The variable <code>a</code> is stored in a separate field called <code>left</code>, and then every other variable is stored in a list called <code>comparators</code>:</p><pre class="language-python"><code class="language-python">comparators<span class="token operator">=</span><span class="token punctuation">[</span>
  Name<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'b'</span><span class="token punctuation">,</span> ctx<span class="token operator">=</span>Load<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  Name<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'c'</span><span class="token punctuation">,</span> ctx<span class="token operator">=</span>Load<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  Name<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'d'</span><span class="token punctuation">,</span> ctx<span class="token operator">=</span>Load<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code></pre><p>In other words: the leftmost variable is stored in <code>left</code>, and every variable on the right of each operator is stored in the respective index of <code>comparators</code>.</p><p>Hopefully that clarifies what the <code>test</code> expression means in our example code:</p><pre class="language-python"><code class="language-python">If<span class="token punctuation">(</span>
  test<span class="token operator">=</span>Compare<span class="token punctuation">(</span>
    left<span class="token operator">=</span>Name<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'answer'</span><span class="token punctuation">,</span> ctx<span class="token operator">=</span>Load<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    ops<span class="token operator">=</span><span class="token punctuation">[</span>Eq<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    comparators<span class="token operator">=</span><span class="token punctuation">[</span>Constant<span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
  <span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code></pre><p><code>left</code> is the <code>Name</code> node 'answer' (basically, a variable), and we have just one comparison going on: <code>Eq</code> being applied on the constant value <code>42</code>. Essentially it is the <code>answer == 42</code> part of the code.</p><p>Now let's look at the body:</p><pre class="language-python"><code class="language-python">    If<span class="token punctuation">(</span>
      test<span class="token operator">=</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>
      body<span class="token operator">=</span><span class="token punctuation">[</span>
        Expr<span class="token punctuation">(</span>
          value<span class="token operator">=</span>Call<span class="token punctuation">(</span>
            func<span class="token operator">=</span>Name<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'print'</span><span class="token punctuation">,</span> ctx<span class="token operator">=</span>Load<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            args<span class="token operator">=</span><span class="token punctuation">[</span>Constant<span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token string">'Correct answer!'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            keywords<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
          <span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      orelse<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">)</span></code></pre><p>The body in our case is a single <code>Expr</code>ession. Note that, when I said that a block or module always contains a list of statements, I wasn't lying. This <code>Expr</code> right here is actually an <strong>expression-statement</strong>. Yeah, I'm not making this up, it will make sense in a bit.</p><h3 id="expressions-vs-statements">Expressions vs. Statements</h3><p>Statements are pretty easy to define. They're kind of like the building blocks of your code. Each statement does something that you can properly define. Such as:</p><ul>
<li>
<p>Creating a variable</p>
<pre class="language-python"><code class="language-python">x <span class="token operator">=</span> <span class="token number">5</span></code></pre>
<p>This one becomes an <code>Assign</code> statement:</p>
<pre class="language-python"><code class="language-python">Assign<span class="token punctuation">(</span>
  targets<span class="token operator">=</span><span class="token punctuation">[</span>
    Name<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'x'</span><span class="token punctuation">,</span> ctx<span class="token operator">=</span>Store<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  value<span class="token operator">=</span>Constant<span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span></code></pre>
<p>Pretty straightforward, the node stores a target and a value. <code>targets</code> here is a list because you can also do multiple assignments: <code>a = b = 5</code>. There will only be one value, though.</p>
</li>
<li>
<p>Importing a module</p>
<pre class="language-python"><code class="language-python"><span class="token keyword">import</span> random</code></pre>
<p>This one becomes an <code>Import</code> statement:</p>
<pre class="language-python"><code class="language-python">Import<span class="token punctuation">(</span>
  names<span class="token operator">=</span><span class="token punctuation">[</span>
    alias<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'random'</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">)</span></code></pre>
</li>
<li>
<p>Asserting some property</p>
<pre class="language-python"><code class="language-python"><span class="token keyword">assert</span> <span class="token boolean">False</span></code></pre>
<p>Becomes:</p>
<pre class="language-python"><code class="language-python">Assert<span class="token punctuation">(</span>
  test<span class="token operator">=</span>Constant<span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span></code></pre>
</li>
<li>
<p>Doing absolutely nothing</p>
<pre class="language-python"><code class="language-python"><span class="token keyword">pass</span></code></pre>
<p>Becomes:</p>
<pre class="language-python"><code class="language-python">Pass<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
</li>
</ul><p>On the other hand, an expression is basically anything that evaluates to a value. Any piece of syntax that ends up turning into a "value", such as a number, a string, an object, even a class or function. As long as it returns a value to us, it is an expression.</p><p>This includes:</p><ul>
<li>
<p>Identity checks</p>
<p>This refers to the <code>is</code> expression:</p>
<pre class="language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">=</span> <span class="token number">5</span>
<span class="token operator">>></span><span class="token operator">></span> b <span class="token operator">=</span> a
<span class="token operator">>></span><span class="token operator">></span> b
<span class="token number">5</span>
<span class="token operator">>></span><span class="token operator">></span> a <span class="token keyword">is</span> b
<span class="token boolean">True</span></code></pre>
<p>Clearly, <code>a is b</code> returns either <code>True</code> or <code>False</code>, just like any other conditional check. And since it returns a value, it is an expression.</p>
<p>Here's its AST:</p>
<pre class="language-python"><code class="language-python">Compare<span class="token punctuation">(</span>
  left<span class="token operator">=</span>Name<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'a'</span><span class="token punctuation">,</span> ctx<span class="token operator">=</span>Load<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  ops<span class="token operator">=</span><span class="token punctuation">[</span>Is<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  comparators<span class="token operator">=</span><span class="token punctuation">[</span>
    Name<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'b'</span><span class="token punctuation">,</span> ctx<span class="token operator">=</span>Load<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">)</span></code></pre>
<p>And it really is just like conditionals. Turns out <code>is</code> is treated just as a special operator (like <code>&#x3C;</code>, <code>==</code> and so on) inside a <code>Compare</code> object when talking about ASTs.</p>
</li>
<li>
<p>Function calls</p>
<p>Function calls return a value. That makes them the most obvious example of an expression:</p>
<pre class="language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> os <span class="token keyword">import</span> getpid
<span class="token operator">>></span><span class="token operator">></span> getpid<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">15206</span></code></pre>
<p>Here's what the AST for <code>getpid()</code> looks like, it'se essrntially just a <code>Call</code>:</p>
<pre class="language-python"><code class="language-python">Call<span class="token punctuation">(</span>
  func<span class="token operator">=</span>Name<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'getpid'</span><span class="token punctuation">,</span> ctx<span class="token operator">=</span>Load<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  args<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  keywords<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span></code></pre>
<p><code>print('Hello')</code> would look like this, it has one argument:</p>
<pre class="language-python"><code class="language-python">Call<span class="token punctuation">(</span>
  func<span class="token operator">=</span>Name<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'print'</span><span class="token punctuation">,</span> ctx<span class="token operator">=</span>Load<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  args<span class="token operator">=</span><span class="token punctuation">[</span>Constant<span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token string">'hello'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  keywords<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span></code></pre>
</li>
<li>
<p>Lambdas</p>
<p>Lambdas themselves are expressions. When you create a lambda function, you usually pass it directly as an argument to another function, or assign it to a variable. Here's some examples:</p>
<pre class="language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> <span class="token number">5</span>
<span class="token operator">&lt;</span>function <span class="token operator">&lt;</span><span class="token keyword">lambda</span><span class="token operator">></span> at <span class="token number">0x7f684169cb80</span><span class="token operator">></span>
<span class="token operator">>></span><span class="token operator">></span> returns_five <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> <span class="token number">5</span>
<span class="token operator">>></span><span class="token operator">></span> returns_five<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">5</span>
<span class="token operator">>></span><span class="token operator">></span> is_even <span class="token operator">=</span> <span class="token keyword">lambda</span> num<span class="token punctuation">:</span> num <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">filter</span><span class="token punctuation">(</span>is_even<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> num<span class="token punctuation">:</span> num <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span></code></pre>
<p>And there's the <code>Lambda</code> expression for <code>lambda: 5</code> in the AST:</p>
<pre class="language-python"><code class="language-python">Lambda<span class="token punctuation">(</span>
  args<span class="token operator">=</span>arguments<span class="token punctuation">(</span>
    posonlyargs<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    args<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    kwonlyargs<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    kw_defaults<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    defaults<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">)</span><span class="token punctuation">,</span>
  body<span class="token operator">=</span>Constant<span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span></code></pre>
</li>
</ul><p>Now, if you think about it, a call to <code>print()</code> in a regular code, it's technically a statement, right?</p><pre class="language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">greet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Hello world!'</span><span class="token punctuation">)</span></code></pre><p>As I've said before, blocks of code are essentially just a list of statements. And we also know, that calling <code>print</code> is technically an expression (it even returns <code>None</code>!). So what's going on here?</p><p>The answer is simple: Python lets you treat any expression as a standalone statement. The expression is going to return some value, but that value just gets discarded.</p><p>Getting back to our original AST:</p><pre class="language-python"><code class="language-python">    If<span class="token punctuation">(</span>
      test<span class="token operator">=</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>
      body<span class="token operator">=</span><span class="token punctuation">[</span>
        Expr<span class="token punctuation">(</span>
          value<span class="token operator">=</span>Call<span class="token punctuation">(</span>
            func<span class="token operator">=</span>Name<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'print'</span><span class="token punctuation">,</span> ctx<span class="token operator">=</span>Load<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            args<span class="token operator">=</span><span class="token punctuation">[</span>Constant<span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token string">'Correct answer!'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            keywords<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
          <span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      orelse<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">)</span></code></pre><p>We have an <code>Expr</code> in our body, which is Python's way of saying "This is an expression that's being used as a statement". The actual expression is inside it, a <code>Call</code> to <code>print</code>.</p><p>The last thing left in this example AST is the last line: <code>orelse=[]</code>. <code>orelse</code> refers to <code>else:</code> blocks anywhere in the AST. The name <code>orelse</code> was chosen because <code>else</code> itself is a keyword and can't be used as an attribute name.</p><p>Oh, did you know that <code>for</code> loops in Python can have an else clause?</p><details>
<summary> Extras: The for-else clause </summary>
<p><code>for</code>-<code>else</code> is really interesting. The <code>else</code> in for loops is run whenever the loop runs to its entirety. In other words, it is <em>not</em> run, when you break out of the loop before it finishes.</p>
<p>It's useful for many use-cases, one of them being searching through a list:</p>
<pre class="language-python"><code class="language-python">items <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'Bag'</span><span class="token punctuation">,</span> <span class="token string">'Purse'</span><span class="token punctuation">,</span> <span class="token string">'Phone'</span><span class="token punctuation">,</span> <span class="token string">'Wallet'</span><span class="token punctuation">]</span>

<span class="token keyword">for</span> item <span class="token keyword">in</span> items<span class="token punctuation">:</span>
    <span class="token keyword">if</span> item <span class="token operator">==</span> <span class="token string">'Phone'</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Phone was found in items!'</span><span class="token punctuation">)</span>
        <span class="token keyword">break</span>

<span class="token keyword">else</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Phone was not found in items :('</span><span class="token punctuation">)</span></code></pre>
<p>If we had an <code>else</code>-clause on our for loop, like:</p>
<pre class="language-python"><code class="language-python"><span class="token keyword">for</span> item <span class="token keyword">in</span> items<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'All done'</span><span class="token punctuation">)</span></code></pre>
<p>The AST would look more interesting:</p>
<pre class="language-python"><code class="language-python">For<span class="token punctuation">(</span>
  target<span class="token operator">=</span>Name<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'item'</span><span class="token punctuation">,</span> ctx<span class="token operator">=</span>Store<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token builtin">iter</span><span class="token operator">=</span>Name<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'items'</span><span class="token punctuation">,</span> ctx<span class="token operator">=</span>Load<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  body<span class="token operator">=</span><span class="token punctuation">[</span>
    Expr<span class="token punctuation">(</span>
      value<span class="token operator">=</span>Call<span class="token punctuation">(</span>
        func<span class="token operator">=</span>Name<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'print'</span><span class="token punctuation">,</span> ctx<span class="token operator">=</span>Load<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        args<span class="token operator">=</span><span class="token punctuation">[</span>
          Name<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'item'</span><span class="token punctuation">,</span> ctx<span class="token operator">=</span>Load<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        keywords<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  orelse<span class="token operator">=</span><span class="token punctuation">[</span>
    Expr<span class="token punctuation">(</span>
      value<span class="token operator">=</span>Call<span class="token punctuation">(</span>
        func<span class="token operator">=</span>Name<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'print'</span><span class="token punctuation">,</span> ctx<span class="token operator">=</span>Load<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        args<span class="token operator">=</span><span class="token punctuation">[</span>
          Constant<span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token string">'All done'</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        keywords<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">)</span></code></pre>
<p>Pretty straightforward. Also, <code>If</code> statements have the exact same <code>orelse</code> property as for loops when it comes to ASTs.</p>
</details><p>If you want a detailed reference of all the Nodes that we have in a Python AST, and the corresponding syntax it belongs to, you can either head on to the <a href="https://docs.python.org/3/library/ast.html#node-classes">docs here</a>, or just use <code>ast.dump</code> on a line of code to try and find out for yourself.</p><h3 id="whats-a-ctx">What's a <code>ctx</code>?</h3><p>Ideally, I want you to leave this article understanding every single aspect of Python's ASTs. And if you're one of the few super observant readers, you might have noticed that we glanced over a very small thing in the AST examples shown. You can see it in this code snippet:</p><pre class="language-python"><code class="language-python">Compare<span class="token punctuation">(</span>
  left<span class="token operator">=</span>Name<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'a'</span><span class="token punctuation">,</span> ctx<span class="token operator">=</span>Load<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  ops<span class="token operator">=</span><span class="token punctuation">[</span>Eq<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  comparators<span class="token operator">=</span><span class="token punctuation">[</span>
    Name<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'b'</span><span class="token punctuation">,</span> ctx<span class="token operator">=</span>Load<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">)</span></code></pre><p>We've talked about <code>Compare</code>, we've talked about what the <code>left</code>, <code>ops</code> and <code>comparators</code> fields represent, we've also talked about <code>Name</code> nodes. The only thing left is <code>ctx=Load()</code>. What exactly does that mean?</p><p>If you check all the code snippets we've seen so far, we've actually seen 27 instances of <code>Name</code> nodes in the examples. Out of the 27, 25 have had the property <code>ctx=Load()</code>, but two of them have a different value: <code>ctx=Store()</code>. Like this one:</p><pre class="language-python"><code class="language-python">Assign<span class="token punctuation">(</span>
  targets<span class="token operator">=</span><span class="token punctuation">[</span>
    Name<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'x'</span><span class="token punctuation">,</span> ctx<span class="token operator">=</span>Store<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  value<span class="token operator">=</span>Constant<span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span></code></pre><p><code>ctx</code> (short for "context") is an essential concept of Python (and many other programming languages), and it is related to the whole concept of "variables".</p><p>If I were to ask you "what's a variable?" You might say something like "It can store values which you can use later.", and give some example like:</p><pre class="language-python"><code class="language-python">age <span class="token operator">=</span> <span class="token number">21</span>    <span class="token comment"># Here `age` is being used to store data</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span>  <span class="token comment"># The stored data is being taken out here</span></code></pre><p>And that's exactly what it is. If you look at the AST for this code:</p><pre class="language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">def</span> <span class="token function">get_ast</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>      <span class="token keyword">print</span><span class="token punctuation">(</span>ast<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>ast<span class="token punctuation">.</span>parse<span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">,</span> indent<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">>></span><span class="token operator">></span> get_ast<span class="token punctuation">(</span><span class="token triple-quoted-string string">'''
... age = 21
... print(age)
... '''</span><span class="token punctuation">)</span>
Module<span class="token punctuation">(</span>
  body<span class="token operator">=</span><span class="token punctuation">[</span>
    Assign<span class="token punctuation">(</span>
      targets<span class="token operator">=</span><span class="token punctuation">[</span>
        Name<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'age'</span><span class="token punctuation">,</span> ctx<span class="token operator">=</span>Store<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      value<span class="token operator">=</span>Constant<span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    Expr<span class="token punctuation">(</span>
      value<span class="token operator">=</span>Call<span class="token punctuation">(</span>
        func<span class="token operator">=</span>Name<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'print'</span><span class="token punctuation">,</span> ctx<span class="token operator">=</span>Load<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        args<span class="token operator">=</span><span class="token punctuation">[</span>
          Name<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'age'</span><span class="token punctuation">,</span> ctx<span class="token operator">=</span>Load<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        keywords<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  type_ignores<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span></code></pre><p>So the first statement is an <code>Assign</code>, and the variable <code>age</code> is in the "Store" context (because a new value is being stored into it), and in the second statement it is in "Load" context. Interestingly, <code>print</code> itself is a variable that's being loaded in this statement. Which makes sense, print is essentially a function somewhere in memory, which is accessible by us using the name <code>print</code>.</p><p>Let's look at a couple more. What about this?</p><pre class="language-python"><code class="language-python">age <span class="token operator">=</span> age <span class="token operator">+</span> <span class="token number">1</span></code></pre><p>The AST looks like this:</p><pre class="language-python"><code class="language-python">Assign<span class="token punctuation">(</span>
  targets<span class="token operator">=</span><span class="token punctuation">[</span>
    Name<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'age'</span><span class="token punctuation">,</span> ctx<span class="token operator">=</span>Store<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  value<span class="token operator">=</span>BinOp<span class="token punctuation">(</span>
    left<span class="token operator">=</span>Name<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'age'</span><span class="token punctuation">,</span> ctx<span class="token operator">=</span>Load<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    op<span class="token operator">=</span>Add<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    right<span class="token operator">=</span>Constant<span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">)</span></code></pre><p>The <code>age</code> on the right is in "Load" mode and the one on the left is in "Store" mode. That's why this line of code makes sense: we are Loading the old value, adding 1 to it, and then Storing it.</p><p>This should probably help in explaining how this kind of self-assigning code <em>really works</em> to a newbie programmer in the future.</p><p>One more interesting example is this:</p><pre class="language-python"><code class="language-python">x<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> y</code></pre><p>The AST looks like this:</p><pre class="language-python"><code class="language-python">Assign<span class="token punctuation">(</span>
  targets<span class="token operator">=</span><span class="token punctuation">[</span>
    Subscript<span class="token punctuation">(</span>
      value<span class="token operator">=</span>Name<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'x'</span><span class="token punctuation">,</span> ctx<span class="token operator">=</span>Load<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token builtin">slice</span><span class="token operator">=</span>Constant<span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      ctx<span class="token operator">=</span>Store<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  value<span class="token operator">=</span>Name<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'y'</span><span class="token punctuation">,</span> ctx<span class="token operator">=</span>Load<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span></code></pre><p>Here, <code>x</code> is actually in "Load" mode even though it's on the left side of the assignment. And if you think about it, it makes sense. We need to load <code>x</code>, and then modify one of its indices. It's not <code>x</code> which is being assigned to, only one <em>index</em> of it is being assigned. So the part of the AST that is in <code>Store</code> context is the <code>Subscript</code>, i.e. it is <code>x[5]</code> that's being assigned a new value.</p><p>Hopefully this explains <em>why</em> we explicitly need to tell each variable whether it is in a load or store context in the AST.</p><p>Now unless you're super familiar with Python, you'd think that <code>Load</code> and <code>Store</code> cover everything that the language needs, but weirdly enough there's a third possible <code>ctx</code> value, <code>Del</code>:</p><pre class="language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> get_ast<span class="token punctuation">(</span><span class="token string">'del x'</span><span class="token punctuation">)</span>
Module<span class="token punctuation">(</span>
  body<span class="token operator">=</span><span class="token punctuation">[</span>
    Delete<span class="token punctuation">(</span>
      targets<span class="token operator">=</span><span class="token punctuation">[</span>Name<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'x'</span><span class="token punctuation">,</span> ctx<span class="token operator">=</span>Del<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  type_ignores<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span></code></pre><details>
<summary> Extras: why `del` exists </summary>
<p>So Python is a <em>reference-counted, garbage collected language</em>. What that means is that there's a very clear distinction between variables and values. Values are essentially just objects floating around in memory, and variables are just names that point to the said objects in memory.</p>
<p>For each variable that points to a value (a.k.a "references" that value), the reference count of that value is increased. For example:</p>
<pre class="language-python"><code class="language-python">x <span class="token operator">=</span> <span class="token string">'some string'</span>  <span class="token comment"># This string has a ref. count of 1</span>
y <span class="token operator">=</span> x              <span class="token comment"># Now it has a ref. count of 2</span></code></pre>
<p>When a value in memory reaches a reference count of zero, that value is no longer used anywhere in the program. Once that happens, the value is deleted from memory (garbage collected). There's a few reasons why a value can get to zero reference counts, like a function returning:</p>
<pre class="language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    x <span class="token operator">=</span> <span class="token string">'some string'</span>  <span class="token comment"># Ref count 1</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    <span class="token comment"># Now, when this function returns, `x` is deleted</span>
    <span class="token comment"># making the string's reference count zero.</span>

f<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p>Or, if you explicitly delete it:</p>
<pre class="language-python"><code class="language-python">x <span class="token operator">=</span> <span class="token string">'some string'</span>  <span class="token comment"># Count 1</span>
<span class="token keyword">del</span> x              <span class="token comment"># Count 0. That string is gone forever.</span></code></pre>
<p>Note that re-assigning a variable is the same as deleting it and then assigning it. Which means this:</p>
<pre class="language-python"><code class="language-python">x <span class="token operator">=</span> <span class="token string">'some string'</span>   <span class="token comment"># Count 1</span>
x <span class="token operator">=</span> <span class="token string">'other string'</span>  <span class="token comment"># Old string's count goes to 0.</span></code></pre>
<p>... is the same as this:</p>
<pre class="language-python"><code class="language-python">x <span class="token operator">=</span> <span class="token string">'some string'</span>  <span class="token comment"># Count 1</span>
<span class="token keyword">del</span> x              <span class="token comment"># Count goes to 0.</span>
x <span class="token operator">=</span> <span class="token string">'other string'</span></code></pre>
<p>If you want more examples of this, there's a <a href="https://www.youtube.com/watch?v=GGKerIMqHCk">much more in-depth video by Anthony</a>.</p>
</details><p>And just like <code>Store</code>, you can also <code>Del</code> an attribute or an index, and it behaves similarly:</p><pre class="language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> get_ast<span class="token punctuation">(</span><span class="token string">'del x[y]'</span><span class="token punctuation">)</span>
Module<span class="token punctuation">(</span>
  body<span class="token operator">=</span><span class="token punctuation">[</span>
    Delete<span class="token punctuation">(</span>
      targets<span class="token operator">=</span><span class="token punctuation">[</span>
        Subscript<span class="token punctuation">(</span>
          value<span class="token operator">=</span>Name<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'x'</span><span class="token punctuation">,</span> ctx<span class="token operator">=</span>Load<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token builtin">slice</span><span class="token operator">=</span>Name<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'y'</span><span class="token punctuation">,</span> ctx<span class="token operator">=</span>Load<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          ctx<span class="token operator">=</span>Del<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  type_ignores<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span></code></pre><details>
<summary> Extras: type_ignores </summary>
<p>We also haven't talked about the <code>type_ignores=[]</code> thing present at the bottom of every <code>Module</code> we output have seen so far.</p>
<p>It's a topic related to Python's type hints. More specifically, it refers to <code># type: ignore</code> comments present in source code. They're not normally parsed by the AST, but you can pass a flag to the parsing step to tell it to check for these comments. Type checkers like <a href="https://github.com/python/mypy">mypy</a> will use this to get type more information. Take a look at this:</p>
<pre class="language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>ast<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   ast<span class="token punctuation">.</span>parse<span class="token punctuation">(</span><span class="token string">'x = 5 # type: ignore'</span><span class="token punctuation">,</span> type_comments<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   indent<span class="token operator">=</span><span class="token number">2</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span><span class="token punctuation">)</span>
Module<span class="token punctuation">(</span>
  body<span class="token operator">=</span><span class="token punctuation">[</span>
    Assign<span class="token punctuation">(</span>
      targets<span class="token operator">=</span><span class="token punctuation">[</span>
        Name<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'x'</span><span class="token punctuation">,</span> ctx<span class="token operator">=</span>Store<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      value<span class="token operator">=</span>Constant<span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  type_ignores<span class="token operator">=</span><span class="token punctuation">[</span>
    TypeIgnore<span class="token punctuation">(</span>lineno<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> tag<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">)</span></code></pre>
<p>If you want to learn more about mypy and type checkers, I have a <a href="/post/mypy-guide">super long blog</a> on that.</p>
</details><h2 id="walking-the-syntax-trees-with-visitors">Walking the Syntax Trees with Visitors</h2><p>So now we know that our AST represents code using nested Nodes, a structure that is called a "tree". We also know that in a tree structure, a node can have as many children nodes inside it as needed. With all that, comes the question of how does one "read" the tree.</p><p>The most obvious way would be to read it top to bottom, the way it appears in the AST dump that we've seen so many times:</p><pre class="language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> get_ast<span class="token punctuation">(</span><span class="token triple-quoted-string string">'''
... age = 21
... print(age)
... '''</span><span class="token punctuation">)</span>
Module<span class="token punctuation">(</span>
  body<span class="token operator">=</span><span class="token punctuation">[</span>
    Assign<span class="token punctuation">(</span>
      targets<span class="token operator">=</span><span class="token punctuation">[</span>
        Name<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'age'</span><span class="token punctuation">,</span> ctx<span class="token operator">=</span>Store<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      value<span class="token operator">=</span>Constant<span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    Expr<span class="token punctuation">(</span>
      value<span class="token operator">=</span>Call<span class="token punctuation">(</span>
        func<span class="token operator">=</span>Name<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'print'</span><span class="token punctuation">,</span> ctx<span class="token operator">=</span>Load<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        args<span class="token operator">=</span><span class="token punctuation">[</span>
          Name<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'age'</span><span class="token punctuation">,</span> ctx<span class="token operator">=</span>Load<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        keywords<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  type_ignores<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span></code></pre><p>We have a <code>Module</code>, which has two nodes in its body: an <code>Assign</code> which has a <code>Name</code> and a <code>Constant</code>, and an <code>Expr</code> which has a <code>Call</code> with a couple <code>Name</code> nodes.</p><p>This way of reading from parent node to child node, in the sequence they appear, is called a pre-order traversal of the tree. And for most intents and purposes, it is what you need.</p><p>To implement this sort of traversal of an AST, Python provides you the <code>NodeVisitor</code> class, which you can use like this:</p><pre class="language-python"><code class="language-python"><span class="token keyword">import</span> ast

<span class="token keyword">class</span> <span class="token class-name">MyVisitor</span><span class="token punctuation">(</span>ast<span class="token punctuation">.</span>NodeVisitor<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">generic_visit</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'entering </span><span class="token interpolation"><span class="token punctuation">{</span>node<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__name__<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>generic_visit<span class="token punctuation">(</span>node<span class="token punctuation">)</span>

visitor <span class="token operator">=</span> MyVisitor<span class="token punctuation">(</span><span class="token punctuation">)</span>

tree <span class="token operator">=</span> ast<span class="token punctuation">.</span>parse<span class="token punctuation">(</span><span class="token triple-quoted-string string">'''
age = 21
print(age)
'''</span><span class="token punctuation">)</span>
visitor<span class="token punctuation">.</span>visit<span class="token punctuation">(</span>tree<span class="token punctuation">)</span></code></pre><blockquote>
<p>We'll look closer at the code inside <code>MyVisitor</code> very soon, but let's try and examine its output first.</p>
</blockquote><p>This outputs the following:</p><pre class="language-text"><code class="language-text">entering Module
entering Assign
entering Name
entering Store
entering Constant
entering Expr
entering Call
entering Name
entering Load
entering Name
entering Load</code></pre><p>To make this output slightly more detailed, let's not just print the class name, but the entire node:</p><pre class="language-python"><code class="language-python"><span class="token keyword">import</span> ast

<span class="token keyword">class</span> <span class="token class-name">MyVisitor</span><span class="token punctuation">(</span>ast<span class="token punctuation">.</span>NodeVisitor<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">generic_visit</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'entering </span><span class="token interpolation"><span class="token punctuation">{</span>ast<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>generic_visit<span class="token punctuation">(</span>node<span class="token punctuation">)</span>

visitor <span class="token operator">=</span> MyVisitor<span class="token punctuation">(</span><span class="token punctuation">)</span>

tree <span class="token operator">=</span> ast<span class="token punctuation">.</span>parse<span class="token punctuation">(</span><span class="token triple-quoted-string string">'''
x = 5
print(x)
'''</span><span class="token punctuation">)</span>
visitor<span class="token punctuation">.</span>visit<span class="token punctuation">(</span>tree<span class="token punctuation">)</span></code></pre><p>There's a lot more output, but it might help to look at it:</p><pre class="language-python"><code class="language-python">entering Module<span class="token punctuation">(</span>body<span class="token operator">=</span><span class="token punctuation">[</span>Assign<span class="token punctuation">(</span>targets<span class="token operator">=</span><span class="token punctuation">[</span>Name<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'x'</span><span class="token punctuation">,</span> ctx<span class="token operator">=</span>Store<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> value<span class="token operator">=</span>Constant<span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Expr<span class="token punctuation">(</span>value<span class="token operator">=</span>Call<span class="token punctuation">(</span>func<span class="token operator">=</span>Name<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'print'</span><span class="token punctuation">,</span> ctx<span class="token operator">=</span>Load<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">[</span>Name<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'x'</span><span class="token punctuation">,</span> ctx<span class="token operator">=</span>Load<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> keywords<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> type_ignores<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
entering Assign<span class="token punctuation">(</span>targets<span class="token operator">=</span><span class="token punctuation">[</span>Name<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'x'</span><span class="token punctuation">,</span> ctx<span class="token operator">=</span>Store<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> value<span class="token operator">=</span>Constant<span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
entering Name<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'x'</span><span class="token punctuation">,</span> ctx<span class="token operator">=</span>Store<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
entering Store<span class="token punctuation">(</span><span class="token punctuation">)</span>
entering Constant<span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
entering Expr<span class="token punctuation">(</span>value<span class="token operator">=</span>Call<span class="token punctuation">(</span>func<span class="token operator">=</span>Name<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'print'</span><span class="token punctuation">,</span> ctx<span class="token operator">=</span>Load<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">[</span>Name<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'x'</span><span class="token punctuation">,</span> ctx<span class="token operator">=</span>Load<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> keywords<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
entering Call<span class="token punctuation">(</span>func<span class="token operator">=</span>Name<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'print'</span><span class="token punctuation">,</span> ctx<span class="token operator">=</span>Load<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">[</span>Name<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'x'</span><span class="token punctuation">,</span> ctx<span class="token operator">=</span>Load<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> keywords<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
entering Name<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'print'</span><span class="token punctuation">,</span> ctx<span class="token operator">=</span>Load<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
entering Load<span class="token punctuation">(</span><span class="token punctuation">)</span>
entering Name<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'x'</span><span class="token punctuation">,</span> ctx<span class="token operator">=</span>Load<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
entering Load<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>You might notice that the first line output is the entire <code>Module</code>. The second line is the <code>Assign</code> node that is inside the <code>Module</code>, and the third line is a <code>Name</code> node which is inside that. Interesting.</p><p>With that, let's understand what's going on. You can imagine this "visitor" moving from up to down, left to right in this tree structure:</p><pre class="language-text"><code class="language-text">               &lt;----Module---->
              /                \
         Assign                 Expr
        /      \                 |
 Name('x')   Constant(5)        Call
  |                            /    \
Store()            Name('print')    Name('x')
                    |                |
                   Load()           Load()</code></pre><p>It starts from the <code>Module</code>, then for each child it visits, it visits the entirety of one of its children before going to the next child. As in, it visits the entirety of the <code>Assign</code> sub-tree before moving on to <code>Expr</code> part of the tree, and so on.</p><p>How it does this, is all hidden in our <code>generic_visit()</code> implementation. Let's start tweaking it to see what results we get. Here's a simpler example:</p><pre class="language-python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">MyVisitor</span><span class="token punctuation">(</span>ast<span class="token punctuation">.</span>NodeVisitor<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">generic_visit</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'entering </span><span class="token interpolation"><span class="token punctuation">{</span>node<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__name__<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>generic_visit<span class="token punctuation">(</span>node<span class="token punctuation">)</span>

visitor <span class="token operator">=</span> MyVisitor<span class="token punctuation">(</span><span class="token punctuation">)</span>

tree <span class="token operator">=</span> ast<span class="token punctuation">.</span>parse<span class="token punctuation">(</span><span class="token string">'x = 5'</span><span class="token punctuation">)</span>
visitor<span class="token punctuation">.</span>visit<span class="token punctuation">(</span>tree<span class="token punctuation">)</span></code></pre><pre class="language-text"><code class="language-text">entering Module
entering Assign
entering Name
entering Store
entering Constant</code></pre><p>Now let's move the <code>print</code> statement to below the <code>super</code> call, see what happens:</p><pre class="language-python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">MyVisitor</span><span class="token punctuation">(</span>ast<span class="token punctuation">.</span>NodeVisitor<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">generic_visit</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>generic_visit<span class="token punctuation">(</span>node<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'leaving </span><span class="token interpolation"><span class="token punctuation">{</span>node<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__name__<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>

visitor <span class="token operator">=</span> MyVisitor<span class="token punctuation">(</span><span class="token punctuation">)</span>

tree <span class="token operator">=</span> ast<span class="token punctuation">.</span>parse<span class="token punctuation">(</span><span class="token string">'x = 5'</span><span class="token punctuation">)</span>
visitor<span class="token punctuation">.</span>visit<span class="token punctuation">(</span>tree<span class="token punctuation">)</span></code></pre><pre class="language-text"><code class="language-text">leaving Store
leaving Name
leaving Constant
leaving Assign
leaving Module</code></pre><p>Interesting. So now the prints suddenly happen in sort-of "reverse" order. It's not actually reversed though, but now every child appears before the parent. This bottom-to-top, left-to-right traversal is called post-order traversal.</p><p>So how about if we do both prints together?</p><pre class="language-python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">MyVisitor</span><span class="token punctuation">(</span>ast<span class="token punctuation">.</span>NodeVisitor<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">generic_visit</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'entering </span><span class="token interpolation"><span class="token punctuation">{</span>node<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__name__<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>generic_visit<span class="token punctuation">(</span>node<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'leaving </span><span class="token interpolation"><span class="token punctuation">{</span>node<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__name__<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>

visitor <span class="token operator">=</span> MyVisitor<span class="token punctuation">(</span><span class="token punctuation">)</span>

tree <span class="token operator">=</span> ast<span class="token punctuation">.</span>parse<span class="token punctuation">(</span><span class="token string">'x = 5'</span><span class="token punctuation">)</span>
visitor<span class="token punctuation">.</span>visit<span class="token punctuation">(</span>tree<span class="token punctuation">)</span></code></pre><pre class="language-text"><code class="language-text">entering Module
entering Assign
entering Name
entering Store
leaving Store
leaving Name
entering Constant
leaving Constant
leaving Assign
leaving Module</code></pre><p>If you follow the enter and leave commands one by one, you'll see how this traversal is happening. I've added the corresponding line numbers for each node in an <code>[enter, leave]</code> pair in this graph, and you can follow the traversal from 1 through 10:</p><pre class="language-text"><code class="language-text">           Module [1, 10]
             |
           Assign [2, 9]
          /         \
 Name('x') [3, 6]    Constant(5) [7, 8]
   |
Store() [4, 5]</code></pre><blockquote>
<p>You can keep this in mind, that anything that comes before the <code>super()</code> call is being done in pre-order, and anything that comes after the <code>super()</code> call is being done in post-order.</p>
</blockquote><p>So let's say that for some reason I wanted to find how many statements exist inside all the <code>for</code> loops in my code. To do that, I'd need to do the following:</p><ul>
<li>Traverse through the code to find all <code>For</code> nodes. We're already sorted with that.</li>
<li>Each time we see a <code>For</code> node, we need to start our count from zero.</li>
<li>We must keep counting until we see this same <code>For</code> node again during post-order traversal.</li>
<li>For every node we find below the <code>For</code> node, check if it's a statement, and increment count.</li>
</ul><p>The code for that would look like this:</p><pre class="language-python"><code class="language-python"><span class="token keyword">import</span> ast

<span class="token keyword">class</span> <span class="token class-name">ForStmtCounter</span><span class="token punctuation">(</span>ast<span class="token punctuation">.</span>NodeVisitor<span class="token punctuation">)</span><span class="token punctuation">:</span>
    current_for_node <span class="token operator">=</span> <span class="token boolean">None</span>
    stmt_count <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token keyword">def</span> <span class="token function">generic_visit</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># If we are inside a for node, count statements</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>current_for_node <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> ast<span class="token punctuation">.</span>stmt<span class="token punctuation">)</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>stmt_count <span class="token operator">+=</span> <span class="token number">1</span>

        <span class="token comment"># If we just found a new for node, start counting</span>
        <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> ast<span class="token punctuation">.</span>For<span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>current_for_node <span class="token operator">=</span> node
            self<span class="token punctuation">.</span>stmt_count <span class="token operator">=</span> <span class="token number">0</span>

        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>generic_visit<span class="token punctuation">(</span>node<span class="token punctuation">)</span>

        <span class="token comment"># This runs when coming back up from the children</span>
        <span class="token keyword">if</span> node <span class="token keyword">is</span> self<span class="token punctuation">.</span>current_for_node<span class="token punctuation">:</span>
            <span class="token comment"># We're done counting this node. Print it out</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'For node contains </span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>stmt_count<span class="token punctuation">}</span></span><span class="token string"> statements'</span></span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>current_for_node <span class="token operator">=</span> <span class="token boolean">None</span>

for_statement_counter <span class="token operator">=</span> ForStmtCounter<span class="token punctuation">(</span><span class="token punctuation">)</span>

tree <span class="token operator">=</span> ast<span class="token punctuation">.</span>parse<span class="token punctuation">(</span><span class="token triple-quoted-string string">'''
for i in range(10):
    print(i)

for item in items:
    if item == 42:
        print('Magic item found!')
        break
'''</span><span class="token punctuation">)</span>
for_statement_counter<span class="token punctuation">.</span>visit<span class="token punctuation">(</span>tree<span class="token punctuation">)</span></code></pre><p>And this is the output:</p><pre class="language-text"><code class="language-text">For node contains 1 statements
For node contains 3 statements</code></pre><h2 id="the-power-of-ast-manipulation">The power of AST manipulation</h2><p>The real power of ASTs comes from the fact that you can edit an AST, and then compile and run it, to modify your source code's behaviour at runtime.</p><p>To get into all of that, let me explain a little bit about how Python runs your source code:</p><pre class="language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> ast
<span class="token operator">>></span><span class="token operator">></span> code <span class="token operator">=</span> <span class="token string">'print("hello")'</span>
<span class="token operator">>></span><span class="token operator">></span> tree <span class="token operator">=</span> ast<span class="token punctuation">.</span>parse<span class="token punctuation">(</span>code<span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>ast<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>tree<span class="token punctuation">,</span> indent<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
Module<span class="token punctuation">(</span>
  body<span class="token operator">=</span><span class="token punctuation">[</span>
    Expr<span class="token punctuation">(</span>
      value<span class="token operator">=</span>Call<span class="token punctuation">(</span>
        func<span class="token operator">=</span>Name<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'print'</span><span class="token punctuation">,</span> ctx<span class="token operator">=</span>Load<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        args<span class="token operator">=</span><span class="token punctuation">[</span>
          Constant<span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token string">'hello'</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        keywords<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  type_ignores<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> code_object <span class="token operator">=</span> <span class="token builtin">compile</span><span class="token punctuation">(</span>tree<span class="token punctuation">,</span> <span class="token string">'&lt;my ast>'</span><span class="token punctuation">,</span> <span class="token string">'exec'</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">exec</span><span class="token punctuation">(</span>code_object<span class="token punctuation">)</span>
hello</code></pre><ul>
<li>The first step is to parse the source code. This actually involves two steps, converting the source code into tokens, and then converting the tokens into a valid AST. Python neatly exposes these two parts of the compilation step with the <code>ast.parse</code> function. You can examine the AST produced in the output above.</li>
<li>The next step is to "compile" the given AST into a code object. Code objects are objects that contain compliled pieces of Python "bytecode", the variable names present in the bytecode, and the locations of each part in the actual source.
The <code>compile</code> function takes in the AST, a file name (which we set to <code>'&#x3C;my ast>'</code> in our case), and a mode, which we set to <code>'exec'</code>, which tells compile that we want an executable code object to come out.</li>
<li>The third step is to run the <code>exec()</code> on this code object, which runs this bytecode in the interpreter. It provides the bytecode with all the values present in the local and global scopes, and lets the code run. In our case, this makes the object print out <code>hello</code>.</li>
</ul><blockquote>
<p>If you want a more in-depth explanation of this, I have an entire section on it in my <a href="/post/builtins#compile-exec-and-eval-how-the-code-works">builtins</a> blog.</p>
</blockquote><p>Now since we have the AST in step 1 of this part, we can simply <em>modify the AST</em>, before we run the compile and execute steps, and the output of the program will be different. How cool is that!</p><p>Let's just jump into it with a few simple examples, before we do something really awesome with this.</p><p>Let's write one that changes all numbers in our code to become <code>42</code>, because why not. Here's our test code:</p><pre class="language-python"><code class="language-python"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">)</span>  <span class="token comment"># definitely not 42</span>

num <span class="token operator">=</span> <span class="token number">28</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> x <span class="token operator">+</span> y

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>

output <span class="token operator">=</span> add<span class="token punctuation">(</span>num<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span></code></pre><p>Running this, we get:</p><pre class="language-text"><code class="language-text">13
28
1
2
3
128</code></pre><p>Now, if all numbers in this code were 42, our output would be:</p><pre class="language-text"><code class="language-text">42
42
42
42
42
84</code></pre><p>The last <code>84</code> is from 42 + 42 (instead of 28 + 100).</p><p>So, how would you do this? It's quite straightforward actually. What we do is define a <code>NodeTransformer</code> class. The difference between this and a <code>NodeVisitor</code> is that a <code>Transformer</code> actually returns a node on every visit, which replaces the old node:</p><pre class="language-python"><code class="language-python"><span class="token keyword">import</span> ast

<span class="token keyword">class</span> <span class="token class-name">NumberChanger</span><span class="token punctuation">(</span>ast<span class="token punctuation">.</span>NodeTransformer<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Changes all number literals to 42."""</span>
    <span class="token keyword">def</span> <span class="token function">generic_visit</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># if it isn't an int constant, do nothing with the node</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> ast<span class="token punctuation">.</span>Constant<span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>value<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> node

        <span class="token keyword">return</span> ast<span class="token punctuation">.</span>Constant<span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token number">42</span><span class="token punctuation">)</span></code></pre><p>Let's run it and see our output:</p><pre class="language-python"><code class="language-python">$ python <span class="token operator">-</span>i code<span class="token punctuation">.</span>py
<span class="token operator">>></span><span class="token operator">></span> code <span class="token operator">=</span> <span class="token triple-quoted-string string">'''
... print(13)  # definitely not 42
...
... num = 28
... print(num)
...
... for i in [1, 2, 3]:
...     print(i)
...
... output = add(num, 100)
... print(output)
... '''</span>
<span class="token operator">>></span><span class="token operator">></span> tree <span class="token operator">=</span> ast<span class="token punctuation">.</span>parse<span class="token punctuation">(</span>code<span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> modified_tree <span class="token operator">=</span> NumberChanger<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>visit<span class="token punctuation">(</span>tree<span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">exec</span><span class="token punctuation">(</span><span class="token builtin">compile</span><span class="token punctuation">(</span>modified_tree<span class="token punctuation">,</span> <span class="token string">'&lt;my ast>'</span><span class="token punctuation">,</span> <span class="token string">'exec'</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><p>And, as expected, the output is:</p><pre class="language-text"><code class="language-text">13
28
1
2
3
128</code></pre><p>... wait. That's not right. Something's definitely not right.</p><p>And with that, we are going to talk about something that's really important when it comes to playing around with ASTs: Sometimes, it can be quite hard to get right.</p><p>A tutorial can make any topic seem easy and obvious, but often times it misses out on the whole learning process of making mistakes, discovering new edge cases, and actually understanding how to debug some of these things.</p><p>Okay, mini-rant over. Let's try and debug this thing. To do that, the first thing that we should do is head to the docs:</p><p><a href="https://docs.python.org/3/library/ast.html#ast.NodeTransformer"><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/m9rahn5ut20dcpo3jaqu.png" alt="ast.NodeTransformer Docs"></a></p><p>The first line below a code example says:</p><blockquote>
<p>"Keep in mind that if the node you‚Äôre operating on has child nodes you must either transform the child nodes yourself or call the <code>generic_visit()</code> method for the node first."</p>
</blockquote><p>Ah, yes, we forgot the <code>super()</code> call. But why does that matter?</p><p>The <code>super()</code> call is what propagates the tree traversal down the tree. If you don't call that, the visit method will stop on that specific node, and never visit the node's children. So, let's fix this:</p><pre class="language-python"><code class="language-python"><span class="token keyword">import</span> ast

<span class="token keyword">class</span> <span class="token class-name">NumberChanger</span><span class="token punctuation">(</span>ast<span class="token punctuation">.</span>NodeTransformer<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Changes all number literals to 42."""</span>
    <span class="token keyword">def</span> <span class="token function">generic_visit</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>generic_visit<span class="token punctuation">(</span>node<span class="token punctuation">)</span>  <span class="token comment"># Added this line</span>

        <span class="token comment"># if it isn't an int constant, do nothing with the node</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> ast<span class="token punctuation">.</span>Constant<span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>value<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> node

        <span class="token keyword">return</span> ast<span class="token punctuation">.</span>Constant<span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token number">42</span><span class="token punctuation">)</span></code></pre><p>Let's run it again:</p><pre class="language-python"><code class="language-python">$ python <span class="token operator">-</span>i code<span class="token punctuation">.</span>py
<span class="token operator">>></span><span class="token operator">></span> code <span class="token operator">=</span> <span class="token triple-quoted-string string">'''
... print(13)  # definitely not 42
...
... num = 28
... print(num)
...
... for i in [1, 2, 3]:
...     print(i)
...
... output = add(num, 100)
... print(output)
... '''</span>
<span class="token operator">>></span><span class="token operator">></span> tree <span class="token operator">=</span> ast<span class="token punctuation">.</span>parse<span class="token punctuation">(</span>code<span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> modified_tree <span class="token operator">=</span> NumberChanger<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>visit<span class="token punctuation">(</span>tree<span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">exec</span><span class="token punctuation">(</span><span class="token builtin">compile</span><span class="token punctuation">(</span>modified_tree<span class="token punctuation">,</span> <span class="token string">'&lt;my ast>'</span><span class="token punctuation">,</span> <span class="token string">'exec'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>
  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>
TypeError<span class="token punctuation">:</span> required field <span class="token string">"lineno"</span> missing <span class="token keyword">from</span> expr</code></pre><p>Uh oh. Another error. Welp, back to the docs.</p><p>This is what the rest of the section on <code>NodeTransformer</code> says:</p><p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/fuy4bsireiy58qunpjom.png" alt="There's a section about fix_missing_locations"></p><p>That's exactly what we need to do, run <code>fix_missing_locations</code>. Always read the entirety of the docs, folks. Let's run it again:</p><pre class="language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> modified_tree <span class="token operator">=</span> ast<span class="token punctuation">.</span>fix_missing_locations<span class="token punctuation">(</span>modified_tree<span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">exec</span><span class="token punctuation">(</span><span class="token builtin">compile</span><span class="token punctuation">(</span>modified_tree<span class="token punctuation">,</span> <span class="token string">'&lt;my ast>'</span><span class="token punctuation">,</span> <span class="token string">'exec'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">42</span>
<span class="token number">42</span>
<span class="token number">42</span>
<span class="token number">42</span>
<span class="token number">42</span>
<span class="token number">84</span></code></pre><p>Finally! We were able to modify and run our AST üéâ</p><p>Let's go a little more in depth. This article is super long already, might as well add some more interesting stuff.</p><p>Since it's very common for AST modifications to deal with a specific kind of node, and nothing else (We've already seen a few examples where that would've been useful, such as turning every number into <code>42</code>), The <code>NodeVisitor</code> and <code>NodeTransformer</code> classes both let you define Node-specific visitor methods.</p><p>You define a node-specific visitor method by defining a <code>visit_&#x3C;NodeName></code> method, just as <code>visit_For</code> to just visit for-loops. If the visitor encounters a for loop, it will first see if a <code>visit_For</code> is defined in the class, and run that. If there isn't, it runs <code>generic_visit</code> as the fallback.</p><p>Here's a somewhat wacky example, which lets you run a program that outputs to the terminal, and make it so that it outputs to a file instead. To do that, we're going to rewrite every <code>print</code> call, and add an attribute, <code>file=...</code>, which will make it print to that file instead.</p><p>Let's see what the AST looks like, for a <code>print()</code> call with and without a <code>file=...</code> attribute.</p><pre class="language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> get_ast<span class="token punctuation">(</span><span class="token string">'print(x)'</span><span class="token punctuation">)</span>
Module<span class="token punctuation">(</span>
  body<span class="token operator">=</span><span class="token punctuation">[</span>
    Expr<span class="token punctuation">(</span>
      value<span class="token operator">=</span>Call<span class="token punctuation">(</span>
        func<span class="token operator">=</span>Name<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'print'</span><span class="token punctuation">,</span> ctx<span class="token operator">=</span>Load<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        args<span class="token operator">=</span><span class="token punctuation">[</span>
          Name<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'x'</span><span class="token punctuation">,</span> ctx<span class="token operator">=</span>Load<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        keywords<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  type_ignores<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span>

<span class="token operator">>></span><span class="token operator">></span> get_ast<span class="token punctuation">(</span><span class="token string">'print(x, file=myfile)'</span><span class="token punctuation">)</span>
Module<span class="token punctuation">(</span>
  body<span class="token operator">=</span><span class="token punctuation">[</span>
    Expr<span class="token punctuation">(</span>
      value<span class="token operator">=</span>Call<span class="token punctuation">(</span>
        func<span class="token operator">=</span>Name<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'print'</span><span class="token punctuation">,</span> ctx<span class="token operator">=</span>Load<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        args<span class="token operator">=</span><span class="token punctuation">[</span>
          Name<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'x'</span><span class="token punctuation">,</span> ctx<span class="token operator">=</span>Load<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        keywords<span class="token operator">=</span><span class="token punctuation">[</span>
          keyword<span class="token punctuation">(</span>
            arg<span class="token operator">=</span><span class="token string">'file'</span><span class="token punctuation">,</span>
            value<span class="token operator">=</span>Name<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'myfile'</span><span class="token punctuation">,</span> ctx<span class="token operator">=</span>Load<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">)</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  type_ignores<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span></code></pre><p>So we need to find every <code>Call</code> with the <code>func</code> attribute being <code>Name(id='print')</code>, and add a <code>file</code> property to the <code>Call</code>'s <code>keywords</code>.</p><pre class="language-python"><code class="language-python"><span class="token keyword">import</span> ast

<span class="token keyword">class</span> <span class="token class-name">FileWriter</span><span class="token punctuation">(</span>ast<span class="token punctuation">.</span>NodeTransformer<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">visit_Call</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>generic_visit<span class="token punctuation">(</span>node<span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>func<span class="token punctuation">,</span> ast<span class="token punctuation">.</span>Name<span class="token punctuation">)</span> <span class="token keyword">and</span> node<span class="token punctuation">.</span>func<span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token operator">==</span> <span class="token string">"print"</span><span class="token punctuation">:</span>
            node<span class="token punctuation">.</span>keywords<span class="token punctuation">.</span>append<span class="token punctuation">(</span>
                ast<span class="token punctuation">.</span>keyword<span class="token punctuation">(</span>
                    arg<span class="token operator">=</span><span class="token string">"file"</span><span class="token punctuation">,</span>
                    value<span class="token operator">=</span>ast<span class="token punctuation">.</span>Name<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">"myfile"</span><span class="token punctuation">,</span> ctx<span class="token operator">=</span>ast<span class="token punctuation">.</span>Load<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">)</span>
            <span class="token punctuation">)</span>

        <span class="token comment"># Remember to return the node</span>
        <span class="token keyword">return</span> node</code></pre><p>Time to test this:</p><pre class="language-python"><code class="language-python">$ python <span class="token operator">-</span>i code<span class="token punctuation">.</span>py
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'*'</span> <span class="token operator">*</span> i<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">*</span>
<span class="token operator">**</span>
<span class="token operator">**</span><span class="token operator">*</span>
<span class="token operator">**</span><span class="token operator">**</span>
<span class="token operator">**</span><span class="token operator">**</span><span class="token operator">*</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> ast
<span class="token operator">>></span><span class="token operator">></span> code <span class="token operator">=</span> <span class="token triple-quoted-string string">'''
... for i in range(1, 6):
...     print('*' * i)
... '''</span>
<span class="token operator">>></span><span class="token operator">></span> tree <span class="token operator">=</span> ast<span class="token punctuation">.</span>parse<span class="token punctuation">(</span>code<span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> new_tree <span class="token operator">=</span> FileWriter<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>visit<span class="token punctuation">(</span>tree<span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> new_tree <span class="token operator">=</span> ast<span class="token punctuation">.</span>fix_missing_locations<span class="token punctuation">(</span>new_tree<span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'output.txt'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> myfile<span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">exec</span><span class="token punctuation">(</span><span class="token builtin">compile</span><span class="token punctuation">(</span>new_tree<span class="token punctuation">,</span> <span class="token string">'&lt;ast>'</span><span class="token punctuation">,</span> <span class="token string">'exec'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">>></span><span class="token operator">></span> exit<span class="token punctuation">(</span><span class="token punctuation">)</span>

$ cat output<span class="token punctuation">.</span>txt
<span class="token operator">*</span>
<span class="token operator">**</span>
<span class="token operator">**</span><span class="token operator">*</span>
<span class="token operator">**</span><span class="token operator">**</span>
<span class="token operator">**</span><span class="token operator">**</span><span class="token operator">*</span></code></pre><p>If you want to, a nice exercise for checking your understanding would be to re-write every <code>generic_visit</code> based code we have written so far, and simplify it using <code>visit_X</code> methods instead.</p><p>I'd love to talk a lot more in depth about all the insane stuff you can do in Python by modifying and executing ASTs. But unfortunately there's not enough space in this blog post for that. Trust me.</p><blockquote>
<p>If you really want to look into more examples of this, you can check out the source code of <a href="https://github.com/tusharsadhwani/zxpy">zxpy</a> after reading this article. It is a library that essentially adds new syntax to Python strings, to seamlessly execute shell code within Python. It is mind-bending stuff though.</p>
</blockquote><h2 id="lets-build-a-simple-linter">Let's build: A simple linter</h2><p>We've learned all the key components for this, all that's left to do is to put everything together. Let's write our own linter from scratch.</p><p>Here's the idea:</p><ul>
<li>We're gonna make a <code>Linter</code> class, which holds our "lint rules".</li>
<li>Lint rules are the actual checks that run on the code. They comprise of 3 things:
<ul>
<li>A rule "code" that uniquely identifies it,</li>
<li>A message that explains the rule violation to the user,</li>
<li>And a <code>Checker</code> class, which is an AST visitor that checks which nodes violate this rule in the source code.</li>
</ul>
</li>
<li>Our linter class will register these rules, run them on a file, and print out all violations.</li>
</ul><p>So let's write down our linter framework, <code>mylint.py</code>:</p><pre class="language-python"><code class="language-python"><span class="token keyword">import</span> ast
<span class="token keyword">import</span> os
<span class="token keyword">from</span> typing <span class="token keyword">import</span> NamedTuple


<span class="token keyword">class</span> <span class="token class-name">Violation</span><span class="token punctuation">(</span>NamedTuple<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Every rule violation contains a node that breaks the rule,
    and a message that will be shown to the user.
    """</span>

    node<span class="token punctuation">:</span> ast<span class="token punctuation">.</span>AST
    message<span class="token punctuation">:</span> <span class="token builtin">str</span>


<span class="token keyword">class</span> <span class="token class-name">Checker</span><span class="token punctuation">(</span>ast<span class="token punctuation">.</span>NodeVisitor<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    A Checker is a Visitor that defines a lint rule, and stores all the
    nodes that violate that lint rule.
    """</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> issue_code<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>issue_code <span class="token operator">=</span> issue_code
        self<span class="token punctuation">.</span>violations <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">Linter</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Holds all list rules, and runs them against a source file."""</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>checkers <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">print_violations</span><span class="token punctuation">(</span>checker<span class="token punctuation">,</span> file_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> node<span class="token punctuation">,</span> message <span class="token keyword">in</span> checker<span class="token punctuation">.</span>violations<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>
                <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>file_name<span class="token punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token punctuation">{</span>node<span class="token punctuation">.</span>lineno<span class="token punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token punctuation">{</span>node<span class="token punctuation">.</span>col_offset<span class="token punctuation">}</span></span><span class="token string">: "</span></span>
                <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>checker<span class="token punctuation">.</span>issue_code<span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>message<span class="token punctuation">}</span></span><span class="token string">"</span></span>
            <span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> source_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Runs all lints on a source file."""</span>
        file_name <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>basename<span class="token punctuation">(</span>source_path<span class="token punctuation">)</span>

        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>source_path<span class="token punctuation">)</span> <span class="token keyword">as</span> source_file<span class="token punctuation">:</span>
            source_code <span class="token operator">=</span> source_file<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>

        tree <span class="token operator">=</span> ast<span class="token punctuation">.</span>parse<span class="token punctuation">(</span>source_code<span class="token punctuation">)</span>
        <span class="token keyword">for</span> checker <span class="token keyword">in</span> self<span class="token punctuation">.</span>checkers<span class="token punctuation">:</span>
            checker<span class="token punctuation">.</span>visit<span class="token punctuation">(</span>tree<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>print_violations<span class="token punctuation">(</span>checker<span class="token punctuation">,</span> file_name<span class="token punctuation">)</span></code></pre><p>Sweet. Now that we have a framework, we can start writing our own checkers. Let's start with a simple one, one that checks if a set has duplicate items:</p><pre class="language-python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">SetDuplicateItemChecker</span><span class="token punctuation">(</span>Checker<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Checks if a set in your code has duplicate constants."""</span>

    <span class="token keyword">def</span> <span class="token function">visit_Set</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Stores all the constants this set holds, and finds duplicates"""</span>
        seen_values <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> element <span class="token keyword">in</span> node<span class="token punctuation">.</span>elts<span class="token punctuation">:</span>
            <span class="token comment"># We're only concerned about constant values like ints.</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> ast<span class="token punctuation">.</span>Constant<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">continue</span>

            <span class="token comment"># if it's already in seen values, raise a lint violation.</span>
            value <span class="token operator">=</span> element<span class="token punctuation">.</span>value
            <span class="token keyword">if</span> value <span class="token keyword">in</span> seen_values<span class="token punctuation">:</span>
                violation <span class="token operator">=</span> Violation<span class="token punctuation">(</span>
                    node<span class="token operator">=</span>element<span class="token punctuation">,</span>
                    message<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"Set contains duplicate item: </span><span class="token interpolation"><span class="token punctuation">{</span>value<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
                <span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>violations<span class="token punctuation">.</span>add<span class="token punctuation">(</span>violation<span class="token punctuation">)</span>

            <span class="token keyword">else</span><span class="token punctuation">:</span>
                seen_values<span class="token punctuation">.</span>add<span class="token punctuation">(</span>element<span class="token punctuation">.</span>value<span class="token punctuation">)</span></code></pre><p>The only thing left, is to write a <code>main</code> function, that takes the filenames from the commandlint, and runs the linter:</p><pre class="language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    source_path <span class="token operator">=</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>

    linter <span class="token operator">=</span> Linter<span class="token punctuation">(</span><span class="token punctuation">)</span>
    linter<span class="token punctuation">.</span>checkers<span class="token punctuation">.</span>add<span class="token punctuation">(</span>SetDuplicateItemChecker<span class="token punctuation">(</span>issue_code<span class="token operator">=</span><span class="token string">"W001"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    linter<span class="token punctuation">.</span>run<span class="token punctuation">(</span>source_path<span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>That was a lot of code, but hopefully you were able to make sense of all of it. Alright, time to lint some files. I wrote a <code>test.py</code> file to test our linter:</p><pre class="language-python"><code class="language-python">$ cat test<span class="token punctuation">.</span>py
s <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">}</span>
l <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> item <span class="token keyword">in</span> l<span class="token punctuation">:</span>
        methods <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">"GET"</span><span class="token punctuation">,</span>
            <span class="token string">"PUT"</span><span class="token punctuation">,</span>
            <span class="token string">"POST"</span><span class="token punctuation">,</span>
            <span class="token string">"DELETE"</span><span class="token punctuation">,</span>
            <span class="token string">"PUT"</span><span class="token punctuation">,</span>   <span class="token comment"># This is a duplicate</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> item <span class="token keyword">in</span> methods<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>

s2 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">}</span>  <span class="token comment"># Has duplicates</span></code></pre><p>Let's run:</p><pre class="language-bash"><code class="language-bash">$ python mylint.py test.py
test.py:11:12: W001: Set contains duplicate item: <span class="token string">'PUT'</span>
test.py:16:15: W001: Set contains duplicate item: <span class="token number">1</span></code></pre><p>We've successfully written a linter!</p><p>The real fun starts though, with the really intricate lint rules that you can write. So let's write one of those. <strong>Let's try to write a checker that checks for unused variables.</strong></p><p>Here's the idea: Every function has a local scope, where you can define new variables. These variables only exist within that function, they have to be created and used all within that function. But, if a variable is defined but isn't used in a function, that's an unused variable.</p><p>To detect unused variables, we can visit all <code>Name</code> nodes inside a function or class, and see if there's any in <code>Load</code> context. If a variable is only ever present in <code>Store</code> context, that means it's defined but never used. So let's do that:</p><pre class="language-python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">UnusedVariableInScopeChecker</span><span class="token punctuation">(</span>Checker<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Checks if any variables are unused in this node's scope."""</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> issue_code<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>issue_code<span class="token punctuation">)</span>
        <span class="token comment"># unused_names is a dictionary that stores variable names, and</span>
        <span class="token comment"># whether or not they've been found in a "Load" context yet.</span>
        <span class="token comment"># If it's found to be used, its value is turned to False.</span>
        self<span class="token punctuation">.</span>unused_names <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

        <span class="token comment"># name_nodes holds the first occurences of variables.</span>
        self<span class="token punctuation">.</span>name_nodes <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token keyword">def</span> <span class="token function">visit_Name</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Find all nodes that only exist in `Store` context"""</span>
        var_name <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token builtin">id</span>

        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>ctx<span class="token punctuation">,</span> ast<span class="token punctuation">.</span>Store<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># If it's a new name, save the node for later</span>
            <span class="token keyword">if</span> var_name <span class="token keyword">not</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>name_nodes<span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>name_nodes<span class="token punctuation">[</span>var_name<span class="token punctuation">]</span> <span class="token operator">=</span> node

            <span class="token comment"># If we've never seen it before, it is unused.</span>
            <span class="token keyword">if</span> var_name <span class="token keyword">not</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>unused_names<span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>unused_names<span class="token punctuation">[</span>var_name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">True</span>

        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token comment"># It's used somewhere.</span>
            self<span class="token punctuation">.</span>unused_names<span class="token punctuation">[</span>var_name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">False</span></code></pre><p>There's just one caveat: We can't just use this visitor on our entire file, as it won't find all unused variables. Here's a quick code example to demonstrate:</p><pre class="language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    var <span class="token operator">=</span> <span class="token number">5</span>

var <span class="token operator">=</span> <span class="token number">10</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>var<span class="token punctuation">)</span></code></pre><p>Here, we would see <code>var</code> being used in the global scope. Because of that, the checker won't catch the unused <code>var</code> inside <code>func()</code>, if we only run it on the entire file. We actually want to run this checker on <em>every single function and class in the file</em>.</p><p>So that's exactly what we are going to do. We will write a checker that runs this checker inside it. Yeah, my mind was also blown when I realised I can run visitors inside visitors. But here's the plan: For every <code>ClassDef</code> and <code>FunctionDef</code>, we will run the above checker on them to find unused local variables, and we will also run it on the <code>Module</code> to find globally unused variables. Sounds good?</p><pre class="language-python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">UnusedVariableChecker</span><span class="token punctuation">(</span>Checker<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">check_for_unused_variables</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Find unused variables in the local scope of this node."""</span>
        visitor <span class="token operator">=</span> UnusedVariableInScopeChecker<span class="token punctuation">(</span>self<span class="token punctuation">.</span>issue_code<span class="token punctuation">)</span>
        visitor<span class="token punctuation">.</span>visit<span class="token punctuation">(</span>node<span class="token punctuation">)</span>

        <span class="token comment"># Now the visitor has collected data, and we can use that data</span>
        <span class="token keyword">for</span> name<span class="token punctuation">,</span> unused <span class="token keyword">in</span> visitor<span class="token punctuation">.</span>unused_names<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> unused<span class="token punctuation">:</span>
                node <span class="token operator">=</span> visitor<span class="token punctuation">.</span>name_nodes<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
                self<span class="token punctuation">.</span>violations<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Violation<span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"Unused variable: </span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">visit_Module</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>check_for_unused_variables<span class="token punctuation">(</span>node<span class="token punctuation">)</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>generic_visit<span class="token punctuation">(</span>node<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">visit_ClassDef</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>check_for_unused_variables<span class="token punctuation">(</span>node<span class="token punctuation">)</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>generic_visit<span class="token punctuation">(</span>node<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">visit_FunctionDef</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>check_for_unused_variables<span class="token punctuation">(</span>node<span class="token punctuation">)</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>generic_visit<span class="token punctuation">(</span>node<span class="token punctuation">)</span></code></pre><p>All that's left now, is to enable this checker in the <code>main</code> function:</p><pre class="language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    source_path <span class="token operator">=</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>

    linter <span class="token operator">=</span> Linter<span class="token punctuation">(</span><span class="token punctuation">)</span>
    linter<span class="token punctuation">.</span>checkers<span class="token punctuation">.</span>add<span class="token punctuation">(</span>SetDuplicateItemChecker<span class="token punctuation">(</span>issue_code<span class="token operator">=</span><span class="token string">"W001"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    linter<span class="token punctuation">.</span>checkers<span class="token punctuation">.</span>add<span class="token punctuation">(</span>UnusedVariableChecker<span class="token punctuation">(</span>issue_code<span class="token operator">=</span><span class="token string">"W002"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    linter<span class="token punctuation">.</span>run<span class="token punctuation">(</span>source_path<span class="token punctuation">)</span></code></pre><p>I've also prepared a new test file, with some more variables:</p><pre class="language-python"><code class="language-python">s <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">}</span>  <span class="token comment"># Unused global</span>
l <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    var <span class="token operator">=</span> <span class="token number">5</span>  <span class="token comment"># Unused local</span>
    <span class="token keyword">for</span> item <span class="token keyword">in</span> l<span class="token punctuation">:</span>
        methods <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">"GET"</span><span class="token punctuation">,</span>
            <span class="token string">"PUT"</span><span class="token punctuation">,</span>
            <span class="token string">"POST"</span><span class="token punctuation">,</span>
            <span class="token string">"DELETE"</span><span class="token punctuation">,</span>
            <span class="token string">"PUT"</span><span class="token punctuation">,</span>  <span class="token comment"># Duplicate</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> item <span class="token keyword">in</span> methods<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>

s2 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">}</span>  <span class="token comment"># Unused, and has a duplicate</span>
var <span class="token operator">=</span> <span class="token number">7</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>var<span class="token punctuation">)</span></code></pre><p>Alright, let's run it!</p><pre class="language-bash"><code class="language-bash">$ python mylint.py test.py
test.py:1:0: W002: Unused variable: <span class="token string">'s'</span>
test.py:17:0: W002: Unused variable: <span class="token string">'s2'</span>
test.py:5:4: W002: Unused variable: <span class="token string">'var'</span>
test.py:17:15: W001: Set contains duplicate item: <span class="token number">1</span>
test.py:12:12: W001: Set contains duplicate item: <span class="token string">'PUT'</span></code></pre><p>It works! We did it, we've built our own linter ü•≥</p><p>If you've made it all the way to this part of the post, congratulations. Even though I've tried my best, I wouldn't be surprised if people still find this article too hard to follow. But, that's just the nature of code analysis -- it's hard. It took me 6 months of working with Python's AST every single day to be able to write this blog, so if you've appreciated the work I'd love to hear about it üôå</p><h2 id="ast-utilities">AST utilities</h2><p>The AST module gives you a few other useful utility classes:</p><ul>
<li>
<p><code>ast.literal_eval</code> can be used as a safer alternative to <code>eval</code>, as <code>literal_eval</code> doesn't access the Python environment, and can only parse literal values, like <code>'abc'</code> or <code>"{'name': 'Mike', 'age': 25}"</code>. But sometimes, that's all you need to evaluate, and it's infinitely safer than using <code>eval</code> for that.</p>
<pre class="language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> ast
<span class="token operator">>></span><span class="token operator">></span> ast<span class="token punctuation">.</span>literal_eval<span class="token punctuation">(</span><span class="token string">'5'</span><span class="token punctuation">)</span>
<span class="token number">5</span>
<span class="token operator">>></span><span class="token operator">></span> ast<span class="token punctuation">.</span>literal_eval<span class="token punctuation">(</span><span class="token string">"{'name': 'Mike', 'age': 25}"</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span><span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'Mike'</span><span class="token punctuation">,</span> <span class="token string">'age'</span><span class="token punctuation">:</span> <span class="token number">25</span><span class="token punctuation">}</span>
<span class="token operator">>></span><span class="token operator">></span> your_password <span class="token operator">=</span> <span class="token string">'password123'</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token string">'"abc" + your_password'</span><span class="token punctuation">)</span>  <span class="token comment"># eval can access variables outside, insecure</span>
<span class="token string">'abcpassword123'</span>
<span class="token operator">>></span><span class="token operator">></span> ast<span class="token punctuation">.</span>literal_eval<span class="token punctuation">(</span><span class="token string">'"abc" + your_password'</span><span class="token punctuation">)</span>  <span class="token comment"># trying to use variables etc. fails</span>
ValueError<span class="token punctuation">:</span> malformed node <span class="token keyword">or</span> string<span class="token punctuation">:</span> <span class="token operator">&lt;</span>ast<span class="token punctuation">.</span>Constant <span class="token builtin">object</span> at <span class="token number">0x7f33a7cdaa90</span><span class="token operator">></span></code></pre>
</li>
<li>
<p><code>ast.unparse</code> was added in Python 3.9, and can take an AST node and convert it back to source code.</p>
<p>Note that ASTs don't store all the information from a source file, so things like exact whitespace information, comments, use of single/double quotes etc. will be lost when you do this. But it still works:</p>
<pre class="language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> ast
<span class="token operator">>></span><span class="token operator">></span> code <span class="token operator">=</span> <span class="token triple-quoted-string string">'''
... def x():
...   print("Hello")  # Some comment
... def y(): pass
... '''</span>
<span class="token operator">>></span><span class="token operator">></span> tree <span class="token operator">=</span> ast<span class="token punctuation">.</span>parse<span class="token punctuation">(</span>code<span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>ast<span class="token punctuation">.</span>unparse<span class="token punctuation">(</span>tree<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Hello'</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span></code></pre>
<p>Re-parsing an un-parsed AST again should generate the same AST.</p>
</li>
<li>
<p><code>ast.walk</code> takes in an AST node and returns a generator, that yields all of its children one by one, in no specific order.</p>
<pre class="language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> ast
<span class="token operator">>></span><span class="token operator">></span> tree <span class="token operator">=</span> ast<span class="token punctuation">.</span>parse<span class="token punctuation">(</span><span class="token triple-quoted-string string">'''
... while True:
...     x = 'hi'
...     if len(x) == 2:
...         break
... '''</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">for</span> node <span class="token keyword">in</span> ast<span class="token punctuation">.</span>walk<span class="token punctuation">(</span>tree<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Found'</span><span class="token punctuation">,</span> node<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__name__<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
Found Module
Found While
Found Constant
Found Assign
Found If
Found Name
Found Constant
Found Compare
Found Break
Found Store
Found Call
Found Eq
Found Constant
Found Name
Found Name
Found Load
Found Load</code></pre>
</li>
</ul><h2 id="what-about-code-formatters">What about code formatters?</h2><p>A little while ago I mentioned that ASTs don't contain certain information like whitespaces, comments, and quote styles. This is because ASTs are meant to be a representation of what the code <em>means</em>, not how the code looks. Anything that Python won't need to store to run the code, is stripped out.</p><p>Turns out, this is a huge problem if you want to create things like code formatters, which need to be able to produce the exact source code that was used to build the syntax trees. If you don't, everytime the code formatter runs on your file, the whole file will look completely different from how you wrote the code.</p><p>For such use cases, we need what is called a <strong>Concrete Syntax Tree</strong>, or CST. A CST is essentially just an AST which contains style information as well, such as where the newlines are, how many spaces are used for indentation, and so on.</p><p>If you need to build a code editor, formatter, or something of that sort for Python, I'll highly recommend <a href="https://github.com/Instagram/LibCST">libcst</a>. It's the best CST library for Python that I know of.</p><h2 id="where-can-i-learn-more">Where can I learn more?</h2><p>If you somehow still want to learn more about ASTs, then my first recommendation would be to read all of the <a href="https://docs.python.org/3/library/ast.html">documentation of the ast module</a>. Furthermore, you should also check out <a href="https://greentreesnakes.readthedocs.io/">greentreesnakes</a>, which was the original source of most of the code examples in the official tutorial today. There's a lot of material to read there.</p><p>One of the craziest parts about the <code>ast</code> module is that, even with all the amazing things it lets us do, the entire source code <code>ast.py</code> is just <a href="https://github.com/python/cpython/blob/main/Lib/ast.py">1700 lines of Python code</a>. It's a definite must-read if you want to dive deeper into ASTs.</p><p>The linter that I wrote can be found on <a href="https://github.com/tusharsadhwani/mylint">my github</a>. It can be thought of as an an extremely simplified version of <a href="https://github.com/pycqa/pylint">pylint</a>, one of the most popular linters in Python, which also has its own AST wrapper called <a href="https://github.com/pycqa/astroid">astroid</a>.</p><p>And with that, you've reached the end of the article. I hope you find good use of this.</p>
    </main>
  </article>
</div>



    <hr class="astro-KKTFMSIY">
    <div class="centered astro-KKTFMSIY">
      <astro-root uid="Z1Tf25X"></astro-root>
    </div>
    <div class="back-to-top-wrapper astro-KKTFMSIY">
      <a href="#top" class="back-to-top-link astro-KKTFMSIY" aria-label="Scroll to Top">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-chevron-up astro-KKTFMSIY" viewBox="0 0 16 16">
          <path fill-rule="evenodd" d="M7.646 4.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1-.708.708L8 5.707l-5.646 5.647a.5.5 0 0 1-.708-.708l6-6z" class="astro-KKTFMSIY"></path>
        </svg>
      </a>
    </div>
    <script src="https://utteranc.es/client.js" repo="tusharsadhwani/blog-comments" issue-term="title" theme="dark-blue" crossorigin="anonymous" async>
    </script>
  </body>
  <hr class="astro-ZUKZCZIV">
<footer class="astro-ZUKZCZIV">
  <a href="https://twitter.com/sadhlife" class="astro-ZUKZCZIV">
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="astro-ZUKZCZIV"><path fill="currentColor" d="M23.954 4.569c-.885.389-1.83.654-2.825.775 1.014-.611 1.794-1.574 2.163-2.723-.951.555-2.005.959-3.127 1.184-.896-.959-2.173-1.559-3.591-1.559-2.717 0-4.92 2.203-4.92 4.917 0 .39.045.765.127 1.124C7.691 8.094 4.066 6.13 1.64 3.161c-.427.722-.666 1.561-.666 2.475 0 1.71.87 3.213 2.188 4.096-.807-.026-1.566-.248-2.228-.616v.061c0 2.385 1.693 4.374 3.946 4.827-.413.111-.849.171-1.296.171-.314 0-.615-.03-.916-.086.631 1.953 2.445 3.377 4.604 3.417-1.68 1.319-3.809 2.105-6.102 2.105-.39 0-.779-.023-1.17-.067 2.189 1.394 4.768 2.209 7.557 2.209 9.054 0 13.999-7.496 13.999-13.986 0-.209 0-.42-.015-.63.961-.689 1.8-1.56 2.46-2.548l-.047-.02z" class="astro-ZUKZCZIV"></path></svg>
    <p class="astro-ZUKZCZIV">Follow for Python tips</p>
  </a>
  <a href="https://discord.gg/XjAQ53YbpE" class="astro-ZUKZCZIV">
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="astro-ZUKZCZIV"><path fill="currentColor" d="M20.222 0c1.406 0 2.54 1.137 2.607 2.475V24l-2.677-2.273-1.47-1.338-1.604-1.398.67 2.205H3.71c-1.402 0-2.54-1.065-2.54-2.476V2.48C1.17 1.142 2.31.003 3.715.003h16.5L20.222 0zm-6.118 5.683h-.03l-.202.2c2.073.6 3.076 1.537 3.076 1.537-1.336-.668-2.54-1.002-3.744-1.137-.87-.135-1.74-.064-2.475 0h-.2c-.47 0-1.47.2-2.81.735-.467.203-.735.336-.735.336s1.002-1.002 3.21-1.537l-.135-.135s-1.672-.064-3.477 1.27c0 0-1.805 3.144-1.805 7.02 0 0 1 1.74 3.743 1.806 0 0 .4-.533.805-1.002-1.54-.468-2.14-1.404-2.14-1.404s.134.066.335.2h.06c.03 0 .044.015.06.03v.006c.016.016.03.03.06.03.33.136.66.27.93.4.466.202 1.065.403 1.8.536.93.135 1.996.2 3.21 0 .6-.135 1.2-.267 1.8-.535.39-.2.87-.4 1.397-.737 0 0-.6.936-2.205 1.404.33.466.795 1 .795 1 2.744-.06 3.81-1.8 3.87-1.726 0-3.87-1.815-7.02-1.815-7.02-1.635-1.214-3.165-1.26-3.435-1.26l.056-.02zm.168 4.413c.703 0 1.27.6 1.27 1.335 0 .74-.57 1.34-1.27 1.34-.7 0-1.27-.6-1.27-1.334.002-.74.573-1.338 1.27-1.338zm-4.543 0c.7 0 1.266.6 1.266 1.335 0 .74-.57 1.34-1.27 1.34-.7 0-1.27-.6-1.27-1.334 0-.74.57-1.338 1.27-1.338z" class="astro-ZUKZCZIV"></path></svg>
    <p class="astro-ZUKZCZIV">Join the community</p>
  </a>
  <a href="https://github.com/tusharsadhwani/blog" class="astro-ZUKZCZIV">
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="astro-ZUKZCZIV"><path fill="currentColor" d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12" class="astro-ZUKZCZIV"></path></svg>
    <p class="astro-ZUKZCZIV">Check source code</p>
  </a>
  <a href="https://tusharsadhwani.dev" class="astro-ZUKZCZIV">
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="astro-ZUKZCZIV"><path fill="currentColor" d="M14.31.18l.9.2.73.26.59.3.45.32.34.34.25.34.16.33.1.3.04.26.02.2-.01.13V8.5l-.05.63-.13.55-.21.46-.26.38-.3.31-.33.25-.35.19-.35.14-.33.1-.3.07-.26.04-.21.02H8.83l-.69.05-.59.14-.5.22-.41.27-.33.32-.27.35-.2.36-.15.37-.1.35-.07.32-.04.27-.02.21v3.06H3.23l-.21-.03-.28-.07-.32-.12-.35-.18-.36-.26-.36-.36-.35-.46-.32-.59-.28-.73-.21-.88-.14-1.05L0 11.97l.06-1.22.16-1.04.24-.87.32-.71.36-.57.4-.44.42-.33.42-.24.4-.16.36-.1.32-.05.24-.01h.16l.06.01h8.16v-.83H6.24l-.01-2.75-.02-.37.05-.34.11-.31.17-.28.25-.26.31-.23.38-.2.44-.18.51-.15.58-.12.64-.1.71-.06.77-.04.84-.02 1.27.05 1.07.13zm-6.3 1.98l-.23.33-.08.41.08.41.23.34.33.22.41.09.41-.09.33-.22.23-.34.08-.41-.08-.41-.23-.33-.33-.22-.41-.09-.41.09-.33.22zM21.1 6.11l.28.06.32.12.35.18.36.27.36.35.35.47.32.59.28.73.21.88.14 1.04.05 1.23-.06 1.23-.16 1.04-.24.86-.32.71-.36.57-.4.45-.42.33-.42.24-.4.16-.36.09-.32.05-.24.02-.16-.01h-8.22v.82h5.84l.01 2.76.02.36-.05.34-.11.31-.17.29-.25.25-.31.24-.38.2-.44.17-.51.15-.58.13-.64.09-.71.07-.77.04-.84.01-1.27-.04-1.07-.14-.9-.2-.73-.25-.59-.3-.45-.33-.34-.34-.25-.34-.16-.33-.1-.3-.04-.25-.02-.2.01-.13v-5.34l.05-.64.13-.54.21-.46.26-.38.3-.32.33-.24.35-.2.35-.14.33-.1.3-.06.26-.04.21-.02.13-.01h5.84l.69-.05.59-.14.5-.21.41-.28.33-.32.27-.35.2-.36.15-.36.1-.35.07-.32.04-.28.02-.21V6.07h2.09l.14.01.21.03zm-6.47 14.25l-.23.33-.08.41.08.41.23.33.33.23.41.08.41-.08.33-.23.23-.33.08-.41-.08-.41-.23-.33-.33-.23-.41-.08-.41.08-.33.23z" class="astro-ZUKZCZIV"></path></svg>
    <p class="astro-ZUKZCZIV">View the main site</p>
  </a>
</footer>


  <noscript>
    <img src="https://analytics.tushar.lol/ingress/f6c6e99f-df6a-43f3-9c16-f434cee0278e/pixel.gif" class="astro-KKTFMSIY">
  </noscript>
  <script defer src="https://analytics.tushar.lol/ingress/f6c6e99f-df6a-43f3-9c16-f434cee0278e/script.js"></script>
</html>
